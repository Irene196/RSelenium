<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSelenium: Headless Browsing â€¢ RSelenium</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">RSelenium</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>RSelenium: Headless Browsing</h1>
            
          </div>

    
    
<div class="contents">
<!--
  %\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{RSelenium: Headless browsing.}
-->
<div id="rselenium-headless-browsing-" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#rselenium-headless-browsing-" class="anchor"> </a></body></html>RSelenium : Headless browsing.</h1>
<p>This vignette is divided into three main sections:</p>
<ol style="list-style-type: decimal">
<li><a href="#id1"><code>PhantomJS</code></a></li>
</ol>
<ul>
<li><a href="#id1a">Driving <code>PhantomJS</code> directly.</a></li>
<li><a href="#id1b">Driving <code>PhantomJS</code> using Selenium Server.</a></li>
<li><a href="#id1b">Additional <code>PhantomJS</code> capabilities.</a></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><a href="#id2">X Virtual Frame Buffer</a></li>
</ol>
<ul>
<li><a href="#id2a">Setup</a></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><a href="#id3"><code>PhantomJS</code> API examples</a></li>
</ol>
<ul>
<li><a href="#id3a">Interacting with the console</a></li>
<li><a href="#id3b"><code>PhantomJS</code> writing to file</a></li>
<li><a href="#id3c">Injecting a library into <code>PhantomJS</code></a></li>
<li><a href="#id3d">Starting a <code>PhantomJS</code> Web Server</a></li>
</ul>
<div id="phantomjs" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#phantomjs" class="anchor"> </a></body></html>
<a id="id1"><code>PhantomJS</code></a>
</h2>
<p><code>PhantomJS</code> is a headless WebKit scriptable with a JavaScript API. It has fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG. <code>RSelenium</code> can drive <code>PhantomJS</code> using two methods: directly or via the standalone Selenium Server.</p>
<div id="driving-phantomjs-directly-" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#driving-phantomjs-directly-" class="anchor"> </a></body></html>
<a id="id1a">Driving <code>PhantomJS</code> directly.</a>
</h3>
<p>The <code>PhantomJS</code> binary can be driven directly with <code>RSelenium</code>. <code>PhantomJS</code> needs to be started in webdriver mode then <code>RSelenium</code> can <strong>communicate with it directly without the need for Selenium Server.</strong> The command line options for <code>PhantomJS</code> are outlined at <a href="http://phantomjs.org/api/command-line.html" class="uri">http://phantomjs.org/api/command-line.html</a>. We note that it is necessary to start <code>PhantomJS</code> with the <code>--webdriver</code> option and an optional IP/port. <code>RSelenium</code> as of <code>v1.3.2</code> has a utility function <code>phantom</code> that will handle starting the <code>PhantomJS</code> binary in webdriver mode by default on port 4444. So to drive <code>PhantomJS</code> sans Selenium Server can be done as follows:</p>
<pre><code>require(RSelenium)
pJS &lt;- phantom()
Sys.sleep(5) # give the binary a moment
remDr &lt;- remoteDriver(browserName = 'phantomjs')
remDr$open()
remDr$navigate("http://www.google.com/ncr")
remDr$getTitle()[[1]] # [1] "Google"
remDr$close
pJS$stop() # close the PhantomJS process, note we dont call remDr$closeServer()</code></pre>
</div>
<div id="driving-phantomjs-using-selenium-server-" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#driving-phantomjs-using-selenium-server-" class="anchor"> </a></body></html>
<a id="id1b">Driving <code>PhantomJS</code> using Selenium Server.</a>
</h3>
<p>For completeness we outline the process of opening a <code>PhantomJS</code> browser using selenium server. It is assummed that the <code>PhantomJS</code> binary is in the users path.</p>
<pre><code>require(RSelenium)
RSelenium::startServer()
remDr &lt;- remoteDriver(browserName = "phantomjs")
remDr$open()
remDr$navigate("http://www.google.com/ncr")
remDr$close()
remDr$closeServer()</code></pre>
<div id="providing-the-phantomjs-path" class="section level4">
<h4 class="hasAnchor">
<html><body><a href="#providing-the-phantomjs-path" class="anchor"> </a></body></html>Providing the <code>PhantomJS</code> path</h4>
<p>It may not be possible for a user to have the <code>PhantomJS</code> binary in their path. In this case a user may pass the path of the <code>PhantomJS</code> binary to Selenium Server:</p>
<pre><code>require(RSelenium)
RSelenium::startServer()
eCap &lt;- list(phantomjs.binary.path = "C:/Users/john/Desktop/phantomjs.exe")
remDr &lt;- remoteDriver(browserName = "phantomjs", extraCapabilities = eCap)
remDr$open()
....
</code></pre>
<p>So in the above example I suppose the <code>PhantomJS</code> binary has been moved to my Desktop which we assume is not in my path. An extra capability <code>phantomjs.binary.path</code> detailed <a href="https://github.com/detro/ghostdriver" class="uri">https://github.com/detro/ghostdriver</a> can be used to provide the path to <code>PhantomJS</code> to Selenium Server.</p>
</div>
</div>
<div id="additional-phantomjs-capabilities-" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#additional-phantomjs-capabilities-" class="anchor"> </a></body></html>
<a id="id1c">Additional <code>PhantomJS</code> capabilities.</a>
</h3>
<div id="setting-a-user-agent" class="section level4">
<h4 class="hasAnchor">
<html><body><a href="#setting-a-user-agent" class="anchor"> </a></body></html>Setting a user agent</h4>
<p>A user agent can be set using the <code>phantomjs.page.settings.userAgent</code> capability.</p>
<pre><code>pJS &lt;- phantom()
Sys.sleep(5)
remDr &lt;- remoteDriver(browserName = "phantomjs")
remDr$open()
remDr$navigate("http://www.whatsmyuseragent.com/")
remDr$findElement("id", "userAgent")$getElementText()[[1]]
# [1] "Your User Agent String is:\nMozilla/5.0 (Unknown; Linux x86_64)
# AppleWebKit/534.34 (KHTML, like Gecko) PhantomJS/1.9.7 Safari/534.34"
remDr$close()
eCap &lt;- list(phantomjs.page.settings.userAgent 
             = "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0) Gecko/20120101 Firefox/29.0")
remDr &lt;- remoteDriver(browserName = "phantomjs", extraCapabilities = eCap)
remDr$open()
remDr$navigate("http://www.whatsmyuseragent.com/")
remDr$findElement("id", "userAgent")$getElementText()[[1]]
# [1] "Your User Agent String is:\nMozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0)
# Gecko/20120101 Firefox/29.0"
remDr$close()
pJS$stop()</code></pre>
<p>The <a href="https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage#webpage-settings" class="uri">https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage#webpage-settings</a> In the above example it can be seen that the default useragent identifies us as <code>PhantomJS</code>. Some web content maybe inaccessible or blocked for <code>PhantomJS</code> users. Here we demonstrate changing our user agent so the website sees us as <code>Firefox 29.0</code>.</p>
</div>
<div id="other-possible-options" class="section level4">
<h4 class="hasAnchor">
<html><body><a href="#other-possible-options" class="anchor"> </a></body></html>Other possible options</h4>
<p>The general form of specifying <a href="https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage#webpage-settings">PhantomJS internal page objects</a> take the form <code>phantomjs.page.settings.SETTING = VALUE</code> where <code>SETTING</code> is the appropriate PhantomJS internal page object. As an example we inhibit the loading of inline images:</p>
<pre><code>require(RSelenium)
pJS &lt;- phantom()
Sys.sleep(5)
eCap &lt;- list(phantomjs.page.settings.loadImages = FALSE)
remDr &lt;- remoteDriver(browserName = "phantomjs", extraCapabilities = eCap)
remDr$open()
remDr$navigate("http://www.google.com/ncr")
remDr$screenshot(display = TRUE)
remDr$close()
pJS$stop()</code></pre>
<p>We can see that the images are not loaded: <img src="https://dl.dropboxusercontent.com/u/38391057/RSelenium/headless/Screenshot%202014-06-03%2014.32.18.png" title="PhantomJS loadImages = FALSE" style="margin-left: auto;margin-right: auto; display: block;" width="100%"></p>
</div>
</div>
</div>
<div id="x-virtual-frame-buffer" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#x-virtual-frame-buffer" class="anchor"> </a></body></html>
<a id="id2">X Virtual Frame Buffer</a>
</h2>
<p>For the discussion on <code>xvfb</code> and the related VPS I refer you to <a href="http://johndharrison.blogspot.com/2014/03/rstudioshiny-server-on-digital-ocean.html">this blog entry</a>. How to setup a VPS with rstudio server and shiny server etc. is outlined.</p>
<div id="setup-" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#setup-" class="anchor"> </a></body></html>
<a id="id2a">Setup.</a>
</h3>
<p>The VPS i am connecting to has an ip of <code>128.199.255.233</code>. I have rstudio server running on port 8787. On the remote server we observe</p>
<pre><code>&gt; library(RSelenium)
&gt; RSelenium::startServer()
&gt; Sys.which('phantomjs')
                 phantomjs 
"/usr/local/bin/phantomjs" 
&gt; Sys.which('firefox')
firefox 
     "" 
&gt; Sys.which('chrome')
chrome 
    "" </code></pre>
<p>So we have started a selenium server running on (default) port 4444. Firefox and google chrome are not currently installed on this remote machine. Lets install firefox first. On the remote VPS we run</p>
<pre><code>sudo apt-get install firefox</code></pre>
<p>Now checking in the remote rstudio</p>
<pre><code>&gt; Sys.which('firefox')
           firefox 
"/usr/bin/firefox" </code></pre>
<p>If we try now to connect to the remote server and open firefox:</p>
<pre><code>&gt; remDr &lt;- remoteDriver(remoteServerAddr = "128.199.255.233")
&gt; remDr$open()
[1] "Connecting to remote server"
Error:    Summary: UnknownError
     Detail: An unknown server-side error occurred while processing the command.
     class: org.openqa.selenium.WebDriverException
</code></pre>
<p>We can see the problem if we try to run firefox in the remote shell:</p>
<p><img src="https://dl.dropboxusercontent.com/u/38391057/RSelenium/headless/firefox.png" title="PhantomJS loadImages = FALSE" style="margin-left: auto;margin-right: auto; display: block;" width="100%"></p>
<p>Firefox is install but there is no display on our headless VPS. We can use <a href="http://www.x.org/archive/X11R7.7/doc/man/man1/Xvfb.1.xhtml">xvfb</a> to provide a virtual display for our browser to run in.</p>
<pre><code>Xvfb :0 -screen 0 1024x768x24 2&gt;&amp;1 &gt;/dev/null &amp;
export DISPLAY=:0
nohup xvfb-run java -jar selenium-server-standalone.jar &gt; selenium.log &amp;</code></pre>
</div>
</div>
<div id="phantomjs-api-examples" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#phantomjs-api-examples" class="anchor"> </a></body></html>
<a id="id3"><code>PhantomJS</code> API examples</a>
</h2>
<p>The <code>phantomExecute</code> method of the <code>remoteDriver</code> class allows the user to interact with the <code>PhantomJS</code> API. Currently the method only works for direct calls to <code>PhantomJS</code> using the <code>phantom</code> utility function. Driving <code>PhantomJS</code> through the <code>Selenium</code> Server and calling the <code>phantomExecute</code> method currently doesnt function and is an open issue (in the ghostDriver project). In the following sections we outline examples of using the <code>PhantomJS</code> API.</p>
<div id="interacting-with-the-console" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#interacting-with-the-console" class="anchor"> </a></body></html>
<a id="id3a"> Interacting with the console</a>
</h3>
<p>The <code>PhantomJS</code> API implements a number of callbacks which can be defined. <a href="http://phantomjs.org/api/webpage/handler/on-load-finished.html">onLoadFinished</a> is one such callback. This callback is invoked when the page finishes the loading. It may accept a single argument indicating the pages status: <code>success</code> if no network errors occurred, otherwise <code>fail</code>. We give a simple example of writing to the console log when a page is loaded.</p>
<pre><code>library(RSelenium)
pJS &lt;- phantom()
remDr &lt;- remoteDriver(browserName = "phantom")
remDr$open()
result &lt;- remDr$phantomExecute("var page = this;
                                page.onLoadFinished = function(status) {
                                var url = page.url;
                                console.log(\"Status:  \" + status);
                                console.log(\"Loaded:  \" + url);
                               };")
# &gt; remDr$navigate("http://www.google.com/ncr")
# Status:  success
# Loaded:  http://www.google.com/
#  &gt; 
# &gt; remDr$navigate("http://www.bbc.co.uk")
# Status:  success
# Loaded:  http://www.bbc.co.uk/
#   Status:  success
# Loaded:  http://www.bbc.com/
pJS$stop()</code></pre>
<p>It can be seen that the callback persists across page calls.</p>
</div>
<div id="phantomjs-writing-to-file" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#phantomjs-writing-to-file" class="anchor"> </a></body></html>
<a id="id3b"> <code>PhantomJS</code> writing to file</a>
</h3>
<p>The next example demonstrates writing to file from <code>PhantomJS</code>. Once again the <code>onLoadFinished</code> callback is utilised. In this example the html source of the page that is navigated to is downloaded to <code>output.htm</code> relative to <code>getwd()</code>. An example is given of using <code>phantom.exit()</code> to close <code>PhantomJS</code> from the API.</p>
<pre><code>library(RSelenium)
pJS &lt;- phantom()
remDr &lt;- remoteDriver(browserName = "phantom")
remDr$open()
result &lt;- remDr$phantomExecute("var page = this;
                                var fs = require(\"fs\");
                                page.onLoadFinished = function(status) {
                                var file = fs.open(\"output.htm\", \"w\");
                                file.write(page.content);
                                file.close();
                                phantom.exit();
                               };")
remDr$navigate("http://www.google.com/ncr")
# &gt; htmlParse("output.htm")['//title/text()'][[1]]
# Google 
pJS$stop()</code></pre>
</div>
<div id="injecting-a-library-into-phantomjs" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#injecting-a-library-into-phantomjs" class="anchor"> </a></body></html>
<a id="id3c"> Injecting a library into <code>PhantomJS</code></a>
</h3>
<p>Next we look at <a href="http://phantomjs.org/api/webpage/method/include-js.html">includeJs</a>. This includes an external script from the specified url (usually a remote location) on the page and executes the callback upon completion. The library we shall include is <code>JQuery</code> using the google CDN. Now any page we call with <code>PhantomJS</code> will have the <code>JQuery</code> library loaded after the page has finished loading.</p>
<pre><code>library(RSelenium)
pJS &lt;- phantom()
remDr &lt;- remoteDriver(browserName = "phantom")
remDr$open()
remDr$navigate("http://www.google.com/ncr")
# check if the JQuery library is loaded
remDr$executeScript("return window.jQuery == undefined;")[[1]]
# TRUE is returned indicating JQuery is not present
result &lt;- remDr$phantomExecute("var page = this;
                                page.onLoadFinished = function(status) {
                                 var url = page.url;
                                 var jURL = 'http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js';
                                 console.log(\"Status:  \" + status);
                                 console.log(\"Loaded:  \" + url);
                                 page.includeJs(jURL, function() {console.log(\"Loaded jQuery!\");})
                                };"
                               )
remDr$navigate("http://www.google.com/ncr")
# Status:  success
# Loaded:  http://www.google.com/
# Loaded jQuery!
remDr$executeScript("return window.jQuery == undefined;")[[1]]
# FALSE is returned indicating that JQuery is present
webElem &lt;- remDr$executeScript("return $(\"[name='q']\").get(0);")[[1]]
webElem$sendKeysToElement(list("PhantomJS was here"))
remDr$screenshot(display = TRUE)
pJS$stop()</code></pre>
<p><img src="https://dl.dropboxusercontent.com/u/38391057/RSelenium/headless/googlePhantomJS.png" title="PhantomJS with Jquery injected" style="margin-left: auto;margin-right: auto; display: block;" width="100%"></p>
</div>
<div id="starting-a-phantomjs-web-server" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#starting-a-phantomjs-web-server" class="anchor"> </a></body></html>
<a id="id3d"> Starting a <code>PhantomJS</code> Web Server</a>
</h3>
<p><code>PhantomJS</code> has the ability to act as a <a href="http://phantomjs.org/api/webserver/">Web Server</a>. Here we demonstrate setting <code>PhantomJS</code> up as a web server on the localhost on port <code>8080</code>. When a user browses to <code>http://localhost:8080</code> they are returned a list of the current blog titles on <a href="http://www.r-bloggers.com" class="uri">http://www.r-bloggers.com</a>. The <code>Jquery</code> library is also injected to aid extraction of the blog titles.</p>
<pre><code>pJS &lt;- phantom()
remDr &lt;- remoteDriver(browserName = "phantom")
remDr$open()
"
var server = require('webserver').create();
server.listen(8080, function (request, response) {
  var page = new WebPage();
  page.open('http://www.r-bloggers.com/', function (status) {
    var jURL = 'http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js';
    page.includeJs(jURL, function() {
      console.log(\"Loaded jQuery!\");
      var blogs = page.evaluate(function () {
        res = $('#mainwrapper .post a[rel=\"bookmark\"]');
        return res.map(function(){return this.innerHTML}).toArray().join('\\n');
      });
      response.statusCode = 200;
      response.write('Current blogs on r-bloggers:\\n');
      response.write(blogs);
      response.write('\\n');
      response.close();
      page.close();
    });
  });
});" -&gt; wsScript

remDr$phantomExecute(wsScript)
# &gt; head(readLines("http://localhost:8080/"))
# Loaded jQuery!
# [1] "Current blogs on r-bloggers:"                        "Specifying complicated groups of time series in hts"
# [3] "Creating Inset Map with ggplot2"                     "R and Vertica"                                      
# [5] "RGolf: NGSL Scrabble"                                "European talks. June-July 2014" 
</code></pre>
<p><img src="https://dl.dropboxusercontent.com/u/38391057/RSelenium/headless/phantomWebserver.png" title="PhantomJS as a Web Server" style="margin-left: auto;margin-right: auto; display: block;" width="100%"></p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#rselenium-headless-browsing.">RSelenium : Headless browsing.</a><ul class="nav nav-pills nav-stacked">
<li>
<a href="#phantomjs"></a><a id="id1"><code>PhantomJS</code></a>
</li>
      <li>
<a href="#x-virtual-frame-buffer"></a><a id="id2">X Virtual Frame Buffer</a>
</li>
      <li>
<a href="#phantomjs-api-examples"></a><a id="id3"><code>PhantomJS</code> API examples</a>
</li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Harrison.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
